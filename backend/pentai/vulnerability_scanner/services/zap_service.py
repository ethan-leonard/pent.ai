import logging
import time
from zapv2 import ZAPv2
from vulnerability_scanner.models import Vulnerability

logger = logging.getLogger(__name__)

class ZAPService:
    """Service for verifying connection to OWASP ZAP and performing scans"""
    
    def __init__(self):
        """Initialize the ZAP service with connection to ZAP API"""
        self.apiKey = None
        # Use localhost since startup.sh maps ZAP to port 8090 on localhost
        self.zap = ZAPv2(
            apikey=self.apiKey, 
            proxies={'http': 'http://localhost:8090', 'https': 'http://localhost:8090'},
        )
        
    def verify_connection(self, url):
        """
        Verify that we can connect to ZAP and access a URL.
        (Existing connection test)
        """
        try:
            logger.info("Attempting to connect to ZAP API")
            version = self.zap.core.version
            logger.info(f"Connected to ZAP version: {version}")
            return {
                "zap_connected": True,
                "zap_version": version,
                "success": True,
                "message": f"Connected to ZAP (version {version})"
            }
        except Exception as e:
            logger.error(f"Error connecting to ZAP: {str(e)}")
            return {
                "zap_connected": False,
                "success": False,
                "error": str(e),
                "message": f"Failed to connect to ZAP: {str(e)}"
            }
    
    def spider_scan(self, url):
        """
        Perform a spider scan on the target URL and return the results.
        """
        try:
            logger.info(f"Opening target URL: {url}")
            self.zap.urlopen(url)
            time.sleep(2)
            
            logger.info(f"Starting spider scan on {url}")
            spider_id = self.zap.spider.scan(url)
            while True:
                status_str = self.zap.spider.status(spider_id)
                try:
                    percent = int(status_str)
                except ValueError:
                    logger.error(f"Unexpected spider status: {status_str}")
                    break
                logger.info(f"Spider scan progress: {percent}%")
                if percent >= 100:
                    break
                time.sleep(1)
            spider_results = self.zap.spider.results(spider_id)
            logger.info(f"Spider scan completed. Results: {spider_results}")
            return {
                "success": True,
                "message": "Spider scan completed.",
                "spider_results": spider_results
            }
        except Exception as e:
            logger.error(f"Error during spider scan: {str(e)}")
            return {
                "success": False,
                "error": str(e),
                "message": f"Spider scan failed: {str(e)}"
            }
    
    def active_scan_all(self, url):
        try:
            logger.info(f"Starting active scan on {url}")
            active_scan_id = self.zap.ascan.scan(url, recurse=True)
            start_time = time.time()
            timeout = 500  # seconds

            last_progress = 0
            last_progress_time = time.time()

            while True:
                status_str = self.zap.ascan.status(active_scan_id)
                try:
                    status_int = int(status_str)
                except ValueError:
                    logger.error(f"Unexpected active scan status: {status_str}")
                    return {
                        "success": False,
                        "error": f"Unexpected scan status: {status_str}",
                        "message": f"Active scan failed with unexpected status: {status_str}"
                    }
                logger.info(f"Active scan progress: {status_int}%")
                
                # Check if progress has increased
                if status_int > last_progress:
                    last_progress = status_int
                    last_progress_time = time.time()
                else:
                    # Additional debug info: log last progress details
                    elapsed = time.time() - last_progress_time
                    logger.debug(f"No progress update for {elapsed:.2f} seconds. Last progress: {last_progress}%, current status: {status_int}%")
                    
                    # If no progress for more than two minutes then stop the scan
                    if elapsed > 60:
                        logger.error("Scan stuck for more than 60 seconds, sending stop command")
                        stop_response = self.zap.ascan.stop(active_scan_id)
                        logger.info(f"Stop command response: {stop_response}")
                        return {
                            "success": False,
                            "error": "Stuck",
                            "message": "Active scan was stopped due to no progress for 60 seconds"
                        }
                
                if status_int >= 100:
                    break
                if time.time() - start_time > timeout:
                    logger.error("Active scan timed out")
                    return {
                        "success": False,
                        "error": "Timeout",
                        "message": f"Active scan timed out after {timeout} seconds"
                    }
                time.sleep(5)

            logger.info("Active scan completed.")
            time.sleep(2)

            # Retrieve all alerts in a paging manner
            st = 0
            pg = 5000
            all_alerts = []
            alerts = self.zap.alert.alerts(baseurl=url, start=st, count=pg)
            while alerts:
                logger.info(f"Reading {pg} alerts from {st}")
                all_alerts.extend(alerts)
                st += pg
                alerts = self.zap.alert.alerts(baseurl=url, start=st, count=pg)
            logger.info(f"Total number of alerts: {len(all_alerts)}")

            return {
                "success": True,
                "message": f"Active scan completed. Found {len(all_alerts)} alerts.",
                "alerts": all_alerts
            }
        except Exception as e:
            logger.error(f"Error during active scan: {str(e)}")
            return {
                "success": False,
                "error": str(e),
                "message": f"Active scan failed: {str(e)}"
            }